<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çø„Çπ„ÇØËøΩ„ÅÑ„Åã„Åë„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</title>
    <style>
        /* Tailwind CSS - ‰∫ãÂâç„Éì„É´„ÉâÊ∏à„ÅøÔºàËªΩÈáèÁâàÔºâ */
        .bg-blue-50 { background-color: rgb(239 246 255); }
        .bg-amber-50 { background-color: rgb(255 251 235); }
        .bg-rose-50 { background-color: rgb(255 241 242); }
        .bg-white { background-color: rgb(255 255 255); }
        .bg-gray-50 { background-color: rgb(249 250 251); }
        .bg-gray-100 { background-color: rgb(243 244 246); }
        .bg-yellow-100 { background-color: rgb(254 249 195); }
        .bg-blue-100 { background-color: rgb(219 234 254); }
        .bg-green-100 { background-color: rgb(220 252 231); }
        .bg-gray-200 { background-color: rgb(229 231 235); }
        
        .text-blue-700 { color: rgb(29 78 216); }
        .text-amber-700 { color: rgb(180 83 9); }
        .text-rose-700 { color: rgb(190 18 60); }
        .text-gray-700 { color: rgb(55 65 81); }
        .text-gray-800 { color: rgb(31 41 55); }
        .text-gray-600 { color: rgb(75 85 99); }
        .text-yellow-800 { color: rgb(133 77 14); }
        .text-blue-800 { color: rgb(30 64 175); }
        .text-green-800 { color: rgb(22 101 52); }
        
        .border { border-width: 1px; }
        .border-gray-200 { border-color: rgb(229 231 235); }
        .border-gray-300 { border-color: rgb(209 213 219); }
        .border-blue-200 { border-color: rgb(191 219 254); }
        .border-amber-200 { border-color: rgb(253 230 138); }
        .border-rose-200 { border-color: rgb(254 205 211); }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded { border-radius: 0.25rem; }
        
        .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-6 { gap: 1.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        
        .w-full { width: 100%; }
        .w-1\/3 { width: 33.333333%; }
        .min-h-screen { min-height: 100vh; }
        .h-auto { height: auto; }
        
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\\:bg-gray-100:hover { background-color: rgb(243 244 246); }
        .cursor-pointer { cursor: pointer; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        
        /* „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
        .column-container {
            min-height: 500px;
        }
        
        .card {
            transition: all 0.2s ease-in-out;
        }
        
        .notion-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        
        .file-drop-zone {
            border: 2px dashed rgba(55, 53, 47, 0.2);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            transition: all 0.2s ease;
            background-color: rgba(55, 53, 47, 0.02);
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: rgba(55, 53, 47, 0.4);
            background-color: rgba(55, 53, 47, 0.04);
        }
        

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }

        .badge-gray {
            background-color: rgb(229 231 235);
            color: rgb(55 65 81);
        }

        .badge-yellow {
            background-color: rgb(254 249 195);
            color: rgb(133 77 14);
        }

        .badge-blue {
            background-color: rgb(219 234 254);
            color: rgb(30 64 175);
        }

        .badge-green {
            background-color: rgb(220 252 231);
            color: rgb(22 101 52);
        }

        .badge-red {
            background-color: rgb(254 226 226);
            color: rgb(153 27 27);
        }

        /* NotionÈ¢®„É°„É¢ÂÖ•ÂäõÊ¨Ñ */
        .memo-input {
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .memo-input:focus {
            outline: none;
            border-color: #2383E2;
            box-shadow: 0 0 0 1px rgba(35, 131, 226, 0.3);
        }

        .memo-input::placeholder {
            color: rgba(55, 53, 47, 0.4);
        }

        
        /* NotionÈ¢®ÂÖ®‰Ωì„Éá„Ç∂„Ç§„É≥ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
            background-color: #F7F6F3;
            color: #37352F;
        }
        
        .notion-card {
            background-color: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(55, 53, 47, 0.09);
        }
        
        .notion-button {
            background-color: #FFFFFF;
            border: 1px solid #DADADA;
            color: #37352F;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .notion-button:hover {
            background-color: #F0F0F0;
        }
        
        .notion-button-primary {
            background-color: rgb(219 234 254);
            color: rgb(29 78 216);
            border: 1px solid rgb(191 219 254);
            border-radius: 0.5rem;
        }
        
        .notion-button-primary:hover {
            background-color: rgb(191 219 254);
            color: rgb(29 78 216);
        }
    </style>
</head>
<body class="min-h-screen" style="background-color: #F7F6F3; padding: 32px 24px;">
    <div class="px-4">
        <div class="mb-6">
            <h1 style="font-size: 28px; font-weight: 700; color: #37352F; margin-bottom: 24px; line-height: 1.2;">„Çø„Çπ„ÇØËøΩ„ÅÑ„Åã„Åë„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
            
            <!-- „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
            <div class="notion-card" style="padding: 24px; margin-bottom: 32px;">
                <div class="file-drop-zone" id="dropZone">
                    <input type="file" id="excelFile" accept=".xlsx,.xlsm" class="hidden">
                    <div class="cursor-pointer" onclick="document.getElementById('excelFile').click()">
                        <p style="color: #37352F; margin-bottom: 8px; font-size: 15px; font-weight: 500;">üìÅ Excel„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åã„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        <p style="color: #787774; font-size: 13px;">ÂØæÂøúÂΩ¢Âºè: .xlsx, .xlsm</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3„Ç´„É©„É†„Éú„Éº„Éâ -->
        <div class="flex gap-6" id="dashboard">
            <!-- „ÅÇ„Å®3Êó•Âàó -->
            <div class="w-1/3">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-semibold text-blue-700 text-center">
                        „ÅÇ„Å®3Êó• <span id="count-3" class="text-sm font-medium">(0)</span>
                    </h2>
                </div>
                <div class="space-y-4 column-container" id="column-3">
                </div>
            </div>

            <!-- „ÅÇ„Å®2Êó•Âàó -->
            <div class="w-1/3">
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-semibold text-amber-700 text-center">
                        „ÅÇ„Å®2Êó• <span id="count-2" class="text-sm font-medium">(0)</span>
                    </h2>
                </div>
                <div class="space-y-4 column-container" id="column-2">
                </div>
            </div>

            <!-- „ÅÇ„Å®1Êó•Âàó -->
            <div class="w-1/3">
                <div class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-semibold text-rose-700 text-center">
                        „ÅÇ„Å®1Êó• <span id="count-1" class="text-sm font-medium">(0)</span>
                    </h2>
                </div>
                <div class="space-y-4 column-container" id="column-1">
                </div>
            </div>
        </div>

        <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
        <div class="mt-6 text-center">
            <button id="saveBtn" class="hidden notion-button-primary" style="padding: 10px 20px; font-size: 14px; font-weight: 500;">
                üíæ Excel„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò
            </button>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let workbook = null;
        let worksheetData = [];
        let originalFilename = '';
        let isXlsmFormat = false;
        
        // „Éá„Éê„ÉÉ„Ç∞Áî®Èñ¢Êï∞Ôºà„Ç≥„É≥„ÇΩ„Éº„É´„ÅÆ„ÅøÔºâ
        function debugLog(message, data) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        // ÂàùÊúüÂåñÂá¶ÁêÜ
        function initializeApp() {
            debugLog('App initialization started');

            // DOMË¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('excelFile');
            
            if (!dropZone) {
                debugLog('ERROR: dropZone element not found');
                return false;
            }
            
            if (!fileInput) {
                debugLog('ERROR: fileInput element not found');
                return false;
            }
            
            // SheetJS„ÅÆÁ¢∫Ë™ç
            if (typeof XLSX === 'undefined') {
                debugLog('ERROR: XLSX library not loaded');
                alert('SheetJS„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return false;
            }
            
            debugLog('SheetJS version: ' + XLSX.version);
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            setupEventListeners(dropZone, fileInput);
            
            debugLog('App initialization completed');
            return true;
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners(dropZone, fileInput) {
            debugLog('Setting up event listeners');
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„Éà
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => highlight(dropZone), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => unhighlight(dropZone), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
            
            // ‰øùÂ≠ò„Éú„Çø„É≥
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', handleSave);
            }
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(element) {
            element.classList.add('drag-over');
        }

        function unhighlight(element) {
            element.classList.remove('drag-over');
        }

        // „Éï„Ç°„Ç§„É´Âá¶ÁêÜÈñ¢Êï∞
        function handleDrop(e) {
            debugLog('File dropped');
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            debugLog('File selected via input');
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            debugLog(`Processing ${files.length} files`);
            
            if (files.length === 0) {
                debugLog('No files selected');
                return;
            }
            
            const file = files[0];
            debugLog('File info', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            
            originalFilename = file.name;
            isXlsmFormat = file.name.toLowerCase().endsWith('.xlsm');
            
            readExcelFile(file);
        }

        function readExcelFile(file) {
            debugLog('Starting to read Excel file');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('FileReader onload triggered');
                
                try {
                    const data = new Uint8Array(e.target.result);
                    debugLog(`File data loaded: ${data.length} bytes`);
                    
                    workbook = XLSX.read(data, { 
                        type: 'array',
                        bookVBA: isXlsmFormat
                    });
                    
                    debugLog('Workbook loaded successfully', workbook.SheetNames);
                    
                    processWorkbook(workbook);
                    
                } catch (error) {
                    debugLog('ERROR reading Excel file: ' + error.message);
                    alert('Excel„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                debugLog('FileReader error', error);
                alert('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processWorkbook(wb) {
            debugLog('Processing workbook');
            
            if (!wb.SheetNames || wb.SheetNames.length === 0) {
                debugLog('ERROR: No sheets found in workbook');
                alert('Excel„Éï„Ç°„Ç§„É´„Å´„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const sheetName = wb.SheetNames[0];
            const worksheet = wb.Sheets[sheetName];
            
            if (!worksheet) {
                debugLog('ERROR: Cannot access worksheet');
                alert('„ÉØ„Éº„ÇØ„Ç∑„Éº„Éà„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }
            
            debugLog('Processing sheet: ' + sheetName);
            
            // „Éá„Éº„ÇøÁØÑÂõ≤„ÅÆÁ¢∫Ë™ç
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            debugLog('Sheet range', range);
            
            const targetData = [];

            for (let row = 8; row <= range.e.r; row++) { // 9Ë°åÁõÆ‰ª•ÈôçÔºà0„Éô„Éº„Çπ„Å™„ÅÆ„Åß8„Åã„ÇâÔºâ
                const cells = [];
                
                for (let col = 1; col <= 8; col++) { // BÂàóÔΩûIÂàóÔºà1ÔΩû8Ôºâ
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cellValue = worksheet[cellAddress] ? worksheet[cellAddress].v : '';
                    cells.push(cellValue);
                }

                // „Éá„Éº„Çø„Åå„ÅÇ„ÇãË°å„ÅÆ„ÅøÂá¶ÁêÜ
                if (cells.some(cell => cell !== '' && cell != null)) {
                    const rowData = {
                        name: cells[0] || '',           // BÂàó: Ê∞èÂêç
                        jobSeekerId: cells[1] || '',    // CÂàó: Ê±ÇËÅ∑ËÄÖNo
                        startDate: cells[2] || '',      // DÂàó: ËøΩ„ÅÑ„Åã„Åë„Çπ„Çø„Éº„ÉàÊó•
                        endDate: cells[3] || '',        // EÂàó: ËøΩ„ÅÑ„Åã„ÅëÊúüÈñì„ÅÆÊúÄÁµÇÊó•
                        remaining: cells[4] || 0,       // FÂàó: ÊÆã‰ª∂Êï∞
                        handMatch: cells[5] || 0,       // GÂàó: Êâã„Éû„ÉÉ„ÉÅ
                        application: cells[6] || 0,     // HÂàó: ÂøúÂãü
                        memo: cells[7] || '',           // IÂàó: „É°„É¢
                        originalRowIndex: row
                    };
                    
                    targetData.push(rowData);
                }
            }
            
            debugLog(`Extracted ${targetData.length} data rows`);
            worksheetData = targetData;
            
            if (targetData.length === 0) {
                debugLog('WARNING: No data found in specified range');
                alert('ÊåáÂÆö„Åï„Çå„ÅüÁØÑÂõ≤ÔºàBÂàóÔΩûIÂàó„ÄÅ9Ë°åÁõÆ‰ª•ÈôçÔºâ„Å´„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            processAndDisplayData(targetData);
            
            // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíË°®Á§∫
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.classList.remove('hidden');
            }
        }

        function processAndDisplayData(data) {
            debugLog('Processing and displaying data');
            
            // ‰ªäÊó•„ÅÆÊó•‰ªòÔºàÊôÇÂàª„Çí00:00:00„Å´„É™„Çª„ÉÉ„ÉàÔºâ
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const columns = {
                3: [], // „ÅÇ„Å®3Êó•
                2: [], // „ÅÇ„Å®2Êó•  
                1: []  // „ÅÇ„Å®1Êó•
            };

            data.forEach((item, index) => {
                if (!item.endDate) {
                    debugLog(`Item ${index}: No endDate, skipping`);
                    return;
                }

                const endDate = parseExcelDate(item.endDate);
                if (!endDate) {
                    debugLog(`Item ${index}: Could not parse endDate: ${item.endDate}`);
                    return;
                }

                // EÂàó„ÅÆÊó•‰ªò„ÇÇÊôÇÂàª„Çí00:00:00„Å´„É™„Çª„ÉÉ„Éà
                const endDateOnly = new Date(endDate);
                endDateOnly.setHours(0, 0, 0, 0);

                // ÊÆãÊó•Êï∞Ë®àÁÆóÔºöEÂàó - ‰ªäÊó•„ÅÆÊó•‰ªò
                const diffTime = endDateOnly.getTime() - today.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                debugLog(`Item ${index} (${item.name}): Today=${today.toDateString()}, EndDate=${endDateOnly.toDateString()}, Days=${diffDays}`);

                // ÊÆãÊó•Êï∞„Å´„Çà„ÇãÂàÜÈ°ûÔºàÂÖÉ„ÅÆÊù°‰ª∂„ÅÆ„Åæ„ÅæÔºâ
                if (isNaN(diffDays)) {
                    debugLog(`Item ${index}: Invalid date calculation, skipping`);
                    return;
                }
                
                if (diffDays === 2) {
                    columns[3].push(item);
                } else if (diffDays === 1) {
                    columns[2].push(item);
                } else if (diffDays === 0) {
                    columns[1].push(item);
                } else {
                    debugLog(`Item ${index}: ${diffDays} days remaining - not in target range (2,1,0)`);
                }
            });

            // ÂêÑÂàó„Çí„ÇΩ„Éº„Éà
            Object.keys(columns).forEach(key => {
                columns[key].sort((a, b) => {
                    // 1. ÊÆã‰ª∂Êï∞„ÅÆÂ∞ë„Å™„ÅÑÈ†Ü
                    const remainingDiff = (a.remaining || 0) - (b.remaining || 0);
                    if (remainingDiff !== 0) return remainingDiff;

                    // 2. Ë°®Á§∫Êó•ÊòáÈ†Ü
                    const dateA = parseExcelDate(a.startDate) || new Date(0);
                    const dateB = parseExcelDate(b.startDate) || new Date(0);
                    const dateDiff = dateA - dateB;
                    if (dateDiff !== 0) return dateDiff;

                    // 3. Ê∞èÂêçÊòáÈ†Ü
                    return (a.name || '').localeCompare(b.name || '');
                });
            });

            debugLog('Column distribution', {
                column3: columns[3].length,
                column2: columns[2].length,
                column1: columns[1].length
            });

            displayCards(columns);
        }

        function parseExcelDate(dateValue) {
            if (!dateValue) return null;
            
            // „Éá„Éê„ÉÉ„Ç∞Áî®
            debugLog(`Parsing date: ${dateValue} (type: ${typeof dateValue})`);
            
            if (typeof dateValue === 'number') {
                // Excel„Ç∑„É™„Ç¢„É´ÂÄ§„ÇíÊó•‰ªò„Å´Â§âÊèõ
                if (dateValue > 0 && dateValue < 100000) { // Â¶•ÂΩì„Å™ÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
                    const excelEpoch = new Date(1899, 11, 30);
                    const result = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                    debugLog(`Parsed Excel serial ${dateValue} to ${result}`);
                    return result;
                }
            } else if (typeof dateValue === 'string') {
                // ÊñáÂ≠óÂàó„ÅÆÊó•‰ªò„Éë„Éº„Çπ
                if (dateValue.trim() === '') return null;
                
                // Êó•Êú¨„ÅÆÊó•‰ªòÂΩ¢Âºè„ÇíË©¶Ë°å
                const patterns = [
                    /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/,  // YYYY/MM/DD, YYYY-MM-DD
                    /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/   // MM/DD/YYYY, DD/MM/YYYY
                ];
                
                for (let pattern of patterns) {
                    const match = dateValue.match(pattern);
                    if (match) {
                        let year, month, day;
                        if (pattern === patterns[0]) {
                            year = parseInt(match[1]);
                            month = parseInt(match[2]) - 1; // 0„Éô„Éº„Çπ
                            day = parseInt(match[3]);
                        } else {
                            // MM/DD/YYYY „Å®„Åó„Å¶Ëß£Èáà
                            year = parseInt(match[3]);
                            month = parseInt(match[1]) - 1;
                            day = parseInt(match[2]);
                        }
                        
                        const result = new Date(year, month, day);
                        if (!isNaN(result.getTime())) {
                            debugLog(`Parsed string "${dateValue}" to ${result}`);
                            return result;
                        }
                    }
                }
                
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Ê®ôÊ∫ñDate constructor
                const result = new Date(dateValue);
                if (!isNaN(result.getTime())) {
                    debugLog(`Parsed string "${dateValue}" with Date constructor to ${result}`);
                    return result;
                }
            } else if (dateValue instanceof Date) {
                if (!isNaN(dateValue.getTime())) {
                    debugLog(`Date object: ${dateValue}`);
                    return dateValue;
                }
            }
            
            debugLog(`Failed to parse date: ${dateValue}`);
            return null;
        }

        function formatDate(date) {
            if (!date) return '';
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        function displayCards(columns) {
            debugLog('Displaying cards');
            
            Object.keys(columns).forEach(key => {
                const columnElement = document.getElementById(`column-${key}`);
                const countElement = document.getElementById(`count-${key}`);
                
                if (!columnElement || !countElement) {
                    debugLog(`ERROR: Column elements not found for key ${key}`);
                    return;
                }
                
                const cards = columns[key];

                // „Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
                countElement.textContent = `(${cards.length})`;

                // „Ç´„Éº„ÉâÁîüÊàê
                columnElement.innerHTML = cards.map(card => createCardHTML(card)).join('');
            });
            
            debugLog('Cards displayed successfully');
        }

        function createCardHTML(data) {
            const remaining = data.remaining || 0;
            const handMatch = data.handMatch || 0;
            const application = data.application || 0;

            // ÊÆãÊï∞„ÅÆËâ≤ÂàÜ„ÅëÔºö0=Ëµ§„ÄÅ1„Äú3=ÈªÑËâ≤„ÄÅ4‰ª•‰∏ä=Èùí
            let remainingBadge;
            if (remaining === 0) {
                remainingBadge = 'badge-red';
            } else if (remaining >= 1 && remaining <= 3) {
                remainingBadge = 'badge-yellow';
            } else {
                remainingBadge = 'badge-blue';
            }

            // Êâã„Éû„ÉÉ„ÉÅ„ÅÆËâ≤ÂàÜ„ÅëÔºö10Êú™Ê∫Ä=Ëµ§„ÄÅ10„Äú19=ÈªÑËâ≤„ÄÅ20‰ª•‰∏ä=Èùí
            let handMatchBadge;
            if (handMatch < 10) {
                handMatchBadge = 'badge-red';
            } else if (handMatch >= 10 && handMatch <= 19) {
                handMatchBadge = 'badge-yellow';
            } else {
                handMatchBadge = 'badge-blue';
            }

            // ÂøúÂãü„ÅÆËâ≤ÂàÜ„ÅëÔºöÊÆãÊï∞+ÂøúÂãüÊï∞<5=Ëµ§„ÄÅÊÆãÊï∞+ÂøúÂãüÊï∞>=5=Èùí
            const totalCount = remaining + application;
            const applicationBadge = totalCount < 5 ? 'badge-red' : 'badge-blue';

            return `
                <div class="notion-card" style="padding: 16px; margin-bottom: 12px; transition: all 0.2s ease;">
                    <!-- „Éò„ÉÉ„ÉÄ„ÉºÔºöÊ±ÇËÅ∑ËÄÖNo + Ê∞èÂêçÔºàÂêå„ÅòË°å„ÉªÂêå„Åò„Çµ„Ç§„Ç∫Ôºâ -->
                    <div class="mb-3 flex items-center gap-2">
                        <span style="font-size: 15px; font-weight: 600; color: #37352F;">${escapeHtml(data.jobSeekerId || '')}</span>
                        <span style="font-size: 15px; font-weight: 600; color: #37352F;">${escapeHtml(data.name || '')}</span>
                    </div>
                    
                    <!-- „Éê„ÉÉ„Ç∏ -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="badge ${remainingBadge}">ÊÆã ${remaining}</span>
                        <span class="badge ${handMatchBadge}">Êâã„Éû„ÉÉ„ÉÅ ${handMatch}</span>
                        <span class="badge ${applicationBadge}">ÂøúÂãü ${application}</span>
                    </div>
                    
                    <!-- „É°„É¢Ê¨Ñ -->
                    <div style="padding: 0 4px;">
                        <textarea 
                            class="memo-input rounded" 
                            rows="2" 
                            placeholder="„É°„É¢„ÇíÂÖ•Âäõ..."
                            data-row-index="${data.originalRowIndex}"
                            onchange="updateMemo(this, ${data.originalRowIndex})"
                            style="width: 100%; font-size: 13px; padding: 8px; resize: none; line-height: 1.5; border: 1px solid rgba(55, 53, 47, 0.16); background-color: #FFFFFF; box-sizing: border-box;"
                        >${escapeHtml(data.memo || '')}</textarea>
                    </div>
                </div>
            `;
        }

        // „É°„É¢Êõ¥Êñ∞Èñ¢Êï∞
        function updateMemo(textarea, rowIndex) {
            const newMemo = textarea.value;
            debugLog(`Updating memo for row ${rowIndex}: ${newMemo}`);
            
            // worksheetData„ÇíÊõ¥Êñ∞
            const dataItem = worksheetData.find(item => item.originalRowIndex === rowIndex);
            if (dataItem) {
                dataItem.memo = newMemo;
                debugLog('Memo updated in worksheetData');
            }
            
            // „ÉØ„Éº„ÇØ„Éñ„ÉÉ„ÇØ„ÅÆ„Çª„É´„ÇÇÊõ¥Êñ∞
            if (workbook && workbook.Sheets) {
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // IÂàóÔºà„É°„É¢ÂàóÔºâ„ÅÆ„Çª„É´„Ç¢„Éâ„É¨„Çπ
                const cellAddress = XLSX.utils.encode_cell({ r: rowIndex, c: 8 });
                
                if (newMemo.trim() === '') {
                    // „É°„É¢„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Çª„É´„ÇíÂâäÈô§
                    delete worksheet[cellAddress];
                } else {
                    // „É°„É¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çª„É´„ÇíÊõ¥Êñ∞
                    worksheet[cellAddress] = { v: newMemo, t: 's' };
                }
                
                debugLog(`Updated Excel cell ${cellAddress} with memo: ${newMemo}`);
            }
        }

        // HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ‰øùÂ≠òÊ©üËÉΩÔºà„Éï„Ç©„É´„ÉÄÊåáÂÆöÂØæÂøúÔºâ
        async function handleSave() {
            debugLog('Save button clicked');
            
            if (!workbook) {
                alert('‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            try {
                const fileType = isXlsmFormat ? 'xlsm' : 'xlsx';
                const defaultFilename = originalFilename || `tasks.${fileType}`;

                // File System Access APIÂØæÂøú„Éñ„É©„Ç¶„Ç∂„ÅÆÂ†¥Âêà
                if ('showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: defaultFilename,
                            types: [{
                                description: 'Excel files',
                                accept: {
                                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
                                    'application/vnd.ms-excel.sheet.macroEnabled.12': ['.xlsm']
                                }
                            }]
                        });

                        // „Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçËæº„Åø
                        const writable = await fileHandle.createWritable();
                        const buffer = XLSX.write(workbook, {
                            bookType: fileType,
                            bookVBA: isXlsmFormat,
                            type: 'buffer'
                        });
                        await writable.write(buffer);
                        await writable.close();

                        alert('„Éï„Ç°„Ç§„É´„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                        debugLog('File saved successfully with folder picker');
                        
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            debugLog('ERROR with folder picker: ' + error.message);
                            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÊ®ôÊ∫ñ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            fallbackSave(fileType, defaultFilename);
                        }
                    }
                } else {
                    // File System Access APIÈùûÂØæÂøú„ÅÆÂ†¥Âêà
                    fallbackSave(fileType, defaultFilename);
                }
                
            } catch (error) {
                debugLog('ERROR saving file: ' + error.message);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰øùÂ≠òÊ©üËÉΩ
        function fallbackSave(fileType, filename) {
            try {
                XLSX.writeFile(workbook, filename, {
                    bookType: fileType,
                    bookVBA: isXlsmFormat
                });
                alert('„Éï„Ç°„Ç§„É´„Åå„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éï„Ç©„É´„ÉÄ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                debugLog('File saved with fallback method');
            } catch (error) {
                debugLog('ERROR with fallback save: ' + error.message);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // DOMContentLoaded„Ç§„Éô„É≥„Éà„ÅßÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM Content Loaded');
            
            // SheetJS„ÅÆË™≠„ÅøËæº„Åø„ÇíÂæÖ„Å§
            if (typeof XLSX === 'undefined') {
                debugLog('XLSX not yet loaded, waiting...');
                setTimeout(() => {
                    initializeApp();
                }, 1000);
            } else {
                initializeApp();
            }
        });

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå
        window.addEventListener('load', function() {
            debugLog('Window loaded');
            if (typeof initializeApp === 'function' && typeof XLSX !== 'undefined') {
                // DOMË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„Çã„ÅãÂÜçÁ¢∫Ë™ç
                if (document.getElementById('dropZone') && document.getElementById('excelFile')) {
                    debugLog('Elements found, reinitializing if needed');
                }
            }
        });
    </script>
</body>
</html>
