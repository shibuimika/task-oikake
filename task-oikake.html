<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¹ã‚¯è¿½ã„ã‹ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        /* Tailwind CSS - äº‹å‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ï¼ˆè»½é‡ç‰ˆï¼‰ */
        .bg-blue-50 { background-color: rgb(239 246 255); }
        .bg-amber-50 { background-color: rgb(255 251 235); }
        .bg-rose-50 { background-color: rgb(255 241 242); }
        .bg-white { background-color: rgb(255 255 255); }
        .bg-gray-50 { background-color: rgb(249 250 251); }
        .bg-gray-100 { background-color: rgb(243 244 246); }
        .bg-yellow-100 { background-color: rgb(254 249 195); }
        .bg-blue-100 { background-color: rgb(219 234 254); }
        .bg-green-100 { background-color: rgb(220 252 231); }
        .bg-gray-200 { background-color: rgb(229 231 235); }
        
        .text-blue-700 { color: rgb(29 78 216); }
        .text-amber-700 { color: rgb(180 83 9); }
        .text-rose-700 { color: rgb(190 18 60); }
        .text-gray-700 { color: rgb(55 65 81); }
        .text-gray-800 { color: rgb(31 41 55); }
        .text-gray-600 { color: rgb(75 85 99); }
        .text-yellow-800 { color: rgb(133 77 14); }
        .text-blue-800 { color: rgb(30 64 175); }
        .text-green-800 { color: rgb(22 101 52); }
        
        .border { border-width: 1px; }
        .border-gray-200 { border-color: rgb(229 231 235); }
        .border-gray-300 { border-color: rgb(209 213 219); }
        .border-blue-200 { border-color: rgb(191 219 254); }
        .border-amber-200 { border-color: rgb(253 230 138); }
        .border-rose-200 { border-color: rgb(254 205 211); }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded { border-radius: 0.25rem; }
        
        .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-6 { gap: 1.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        
        .w-full { width: 100%; }
        .w-1\/3 { width: 33.333333%; }
        .min-h-screen { min-height: 100vh; }
        .h-auto { height: auto; }
        
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\\:bg-gray-100:hover { background-color: rgb(243 244 246); }
        .cursor-pointer { cursor: pointer; }
        
        .hidden { display: none; }
        .block { display: block; }
        
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .column-container {
            min-height: 500px;
        }
        
        .card {
            transition: all 0.2s ease-in-out;
        }
        
        .notion-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        
        .file-drop-zone {
            border: 2px dashed rgba(55, 53, 47, 0.2);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            transition: all 0.2s ease;
            background-color: rgba(55, 53, 47, 0.02);
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: rgba(55, 53, 47, 0.4);
            background-color: rgba(55, 53, 47, 0.04);
        }
        

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }

        .badge-gray {
            background-color: rgb(229 231 235);
            color: rgb(55 65 81);
        }

        .badge-yellow {
            background-color: rgb(254 249 195);
            color: rgb(133 77 14);
        }

        .badge-blue {
            background-color: rgb(219 234 254);
            color: rgb(30 64 175);
        }

        .badge-green {
            background-color: rgb(220 252 231);
            color: rgb(22 101 52);
        }

        .badge-red {
            background-color: rgb(254 226 226);
            color: rgb(153 27 27);
        }

        /* Notioné¢¨ãƒ¡ãƒ¢å…¥åŠ›æ¬„ */
        .memo-input {
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .memo-input:focus {
            outline: none;
            border-color: #2383E2;
            box-shadow: 0 0 0 1px rgba(35, 131, 226, 0.3);
        }

        .memo-input::placeholder {
            color: rgba(55, 53, 47, 0.4);
        }

        
        /* Notioné¢¨å…¨ä½“ãƒ‡ã‚¶ã‚¤ãƒ³ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
            background-color: #F7F6F3;
            color: #37352F;
        }
        
        .notion-card {
            background-color: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(55, 53, 47, 0.09);
        }
        
        .notion-button {
            background-color: #FFFFFF;
            border: 1px solid #DADADA;
            color: #37352F;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .notion-button:hover {
            background-color: #F0F0F0;
        }
        
        .notion-button-primary {
            background-color: rgb(219 234 254);
            color: rgb(29 78 216);
            border: 1px solid rgb(191 219 254);
            border-radius: 0.5rem;
        }
        
        .notion-button-primary:hover {
            background-color: rgb(191 219 254);
            color: rgb(29 78 216);
        }
    </style>
</head>
<body class="min-h-screen" style="background-color: #F7F6F3; padding: 32px 24px;">
    <div class="px-4">
        <div class="mb-6">
            <h1 style="font-size: 28px; font-weight: 700; color: #37352F; margin-bottom: 24px; line-height: 1.2;">ã‚¿ã‚¹ã‚¯è¿½ã„ã‹ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="notion-card" style="padding: 24px; margin-bottom: 32px;">
                <div class="file-drop-zone" id="dropZone">
                    <input type="file" id="excelFile" accept=".xlsx,.xlsm" class="hidden">
                    <div class="cursor-pointer" onclick="document.getElementById('excelFile').click()">
                        <p style="color: #37352F; margin-bottom: 8px; font-size: 15px; font-weight: 500;">ğŸ“ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
                        <p style="color: #787774; font-size: 13px;">å¯¾å¿œå½¢å¼: .xlsx, .xlsm</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3ã‚«ãƒ©ãƒ ãƒœãƒ¼ãƒ‰ -->
        <div class="flex gap-6" id="dashboard">
            <!-- ã‚ã¨3æ—¥åˆ— -->
            <div class="w-1/3">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-semibold text-blue-700 text-center">
                        ã‚ã¨3æ—¥ <span id="count-3" class="text-sm font-medium">(0)</span>
                    </h2>
                </div>
                <div class="space-y-4 column-container" id="column-3">
                </div>
            </div>

            <!-- ã‚ã¨2æ—¥åˆ— -->
            <div class="w-1/3">
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-semibold text-amber-700 text-center">
                        ã‚ã¨2æ—¥ <span id="count-2" class="text-sm font-medium">(0)</span>
                    </h2>
                </div>
                <div class="space-y-4 column-container" id="column-2">
                </div>
            </div>

            <!-- ã‚ã¨1æ—¥åˆ— -->
            <div class="w-1/3">
                <div class="bg-rose-50 border border-rose-200 rounded-lg p-3 mb-4">
                    <h2 class="text-lg font-semibold text-rose-700 text-center">
                        ã‚ã¨1æ—¥ <span id="count-1" class="text-sm font-medium">(0)</span>
                    </h2>
                </div>
                <div class="space-y-4 column-container" id="column-1">
                </div>
            </div>
        </div>

        <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
        <div class="mt-6 text-center">
            <button id="saveBtn" class="hidden notion-button-primary" style="padding: 10px 20px; font-size: 14px; font-weight: 500;">
                ğŸ’¾ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
            </button>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let workbook = null;
        let worksheetData = [];
        let originalFilename = '';
        let isXlsmFormat = false;
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•°ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã¿ï¼‰
        function debugLog(message, data) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        // åˆæœŸåŒ–å‡¦ç†
        function initializeApp() {
            debugLog('App initialization started');

            // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('excelFile');
            
            if (!dropZone) {
                debugLog('ERROR: dropZone element not found');
                return false;
            }
            
            if (!fileInput) {
                debugLog('ERROR: fileInput element not found');
                return false;
            }
            
            // SheetJSã®ç¢ºèª
            if (typeof XLSX === 'undefined') {
                debugLog('ERROR: XLSX library not loaded');
                alert('SheetJSãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return false;
            }
            
            debugLog('SheetJS version: ' + XLSX.version);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners(dropZone, fileInput);
            
            debugLog('App initialization completed');
            return true;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners(dropZone, fileInput) {
            debugLog('Setting up event listeners');
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => highlight(dropZone), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => unhighlight(dropZone), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
            
            // ä¿å­˜ãƒœã‚¿ãƒ³
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', handleSave);
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(element) {
            element.classList.add('drag-over');
        }

        function unhighlight(element) {
            element.classList.remove('drag-over');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†é–¢æ•°
        function handleDrop(e) {
            debugLog('File dropped');
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            debugLog('File selected via input');
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            debugLog(`Processing ${files.length} files`);
            
            if (files.length === 0) {
                debugLog('No files selected');
                return;
            }
            
            const file = files[0];
            debugLog('File info', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            
            originalFilename = file.name;
            isXlsmFormat = file.name.toLowerCase().endsWith('.xlsm');
            
            readExcelFile(file);
        }

        function readExcelFile(file) {
            debugLog('Starting to read Excel file');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debugLog('FileReader onload triggered');
                
                try {
                    const data = new Uint8Array(e.target.result);
                    debugLog(`File data loaded: ${data.length} bytes`);
                    
                    workbook = XLSX.read(data, { 
                        type: 'array',
                        bookVBA: isXlsmFormat
                    });
                    
                    debugLog('Workbook loaded successfully', workbook.SheetNames);
                    
                    processWorkbook(workbook);
                    
                } catch (error) {
                    debugLog('ERROR reading Excel file: ' + error.message);
                    alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                debugLog('FileReader error', error);
                alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processWorkbook(wb) {
            debugLog('Processing workbook');
            
            if (!wb.SheetNames || wb.SheetNames.length === 0) {
                debugLog('ERROR: No sheets found in workbook');
                alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const sheetName = wb.SheetNames[0];
            const worksheet = wb.Sheets[sheetName];
            
            if (!worksheet) {
                debugLog('ERROR: Cannot access worksheet');
                alert('ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
                return;
            }
            
            debugLog('Processing sheet: ' + sheetName);
            
            // ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã®ç¢ºèª
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            debugLog('Sheet range', range);
            
            const targetData = [];

            for (let row = 8; row <= range.e.r; row++) { // 9è¡Œç›®ä»¥é™ï¼ˆ0ãƒ™ãƒ¼ã‚¹ãªã®ã§8ã‹ã‚‰ï¼‰
                const cells = [];
                
                for (let col = 1; col <= 8; col++) { // Båˆ—ï½Iåˆ—ï¼ˆ1ï½8ï¼‰
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cellValue = worksheet[cellAddress] ? worksheet[cellAddress].v : '';
                    cells.push(cellValue);
                }

                // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹è¡Œã®ã¿å‡¦ç†
                if (cells.some(cell => cell !== '' && cell != null)) {
                    const rowData = {
                        name: cells[0] || '',           // Båˆ—: æ°å
                        jobSeekerId: cells[1] || '',    // Cåˆ—: æ±‚è·è€…No
                        startDate: cells[2] || '',      // Dåˆ—: è¿½ã„ã‹ã‘ã‚¹ã‚¿ãƒ¼ãƒˆæ—¥
                        endDate: cells[3] || '',        // Eåˆ—: è¿½ã„ã‹ã‘æœŸé–“ã®æœ€çµ‚æ—¥
                        remaining: cells[4] || 0,       // Fåˆ—: æ®‹ä»¶æ•°
                        handMatch: cells[5] || 0,       // Gåˆ—: æ‰‹ãƒãƒƒãƒ
                        application: cells[6] || 0,     // Håˆ—: å¿œå‹Ÿ
                        memo: cells[7] || '',           // Iåˆ—: ãƒ¡ãƒ¢
                        originalRowIndex: row
                    };
                    
                    targetData.push(rowData);
                }
            }
            
            debugLog(`Extracted ${targetData.length} data rows`);
            worksheetData = targetData;
            
            if (targetData.length === 0) {
                debugLog('WARNING: No data found in specified range');
                alert('æŒ‡å®šã•ã‚ŒãŸç¯„å›²ï¼ˆBåˆ—ï½Iåˆ—ã€9è¡Œç›®ä»¥é™ï¼‰ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            processAndDisplayData(targetData);
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.classList.remove('hidden');
            }
        }

        function processAndDisplayData(data) {
            debugLog('Processing and displaying data');
            
            // ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆæ™‚åˆ»ã‚’00:00:00ã«ãƒªã‚»ãƒƒãƒˆï¼‰
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const columns = {
                3: [], // ã‚ã¨3æ—¥
                2: [], // ã‚ã¨2æ—¥  
                1: []  // ã‚ã¨1æ—¥
            };

            data.forEach((item, index) => {
                if (!item.endDate) {
                    debugLog(`Item ${index}: No endDate, skipping`);
                    return;
                }

                const endDate = parseExcelDate(item.endDate);
                if (!endDate) {
                    debugLog(`Item ${index}: Could not parse endDate: ${item.endDate}`);
                    return;
                }

                // Eåˆ—ã®æ—¥ä»˜ã‚‚æ™‚åˆ»ã‚’00:00:00ã«ãƒªã‚»ãƒƒãƒˆ
                const endDateOnly = new Date(endDate);
                endDateOnly.setHours(0, 0, 0, 0);

                // æ®‹æ—¥æ•°è¨ˆç®—ï¼šEåˆ— - ä»Šæ—¥ã®æ—¥ä»˜
                const diffTime = endDateOnly.getTime() - today.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                debugLog(`Item ${index} (${item.name}): Today=${today.toDateString()}, EndDate=${endDateOnly.toDateString()}, Days=${diffDays}`);

                // æ®‹æ—¥æ•°ã«ã‚ˆã‚‹åˆ†é¡ï¼ˆå…ƒã®æ¡ä»¶ã®ã¾ã¾ï¼‰
                if (isNaN(diffDays)) {
                    debugLog(`Item ${index}: Invalid date calculation, skipping`);
                    return;
                }
                
                if (diffDays === 2) {
                    columns[3].push(item);
                } else if (diffDays === 1) {
                    columns[2].push(item);
                } else if (diffDays === 0) {
                    columns[1].push(item);
                } else {
                    debugLog(`Item ${index}: ${diffDays} days remaining - not in target range (2,1,0)`);
                }
            });

            // å„åˆ—ã‚’ã‚½ãƒ¼ãƒˆ
            Object.keys(columns).forEach(key => {
                columns[key].sort((a, b) => {
                    // 1. æ®‹ä»¶æ•°ã®å°‘ãªã„é †
                    const remainingDiff = (a.remaining || 0) - (b.remaining || 0);
                    if (remainingDiff !== 0) return remainingDiff;

                    // 2. è¡¨ç¤ºæ—¥æ˜‡é †
                    const dateA = parseExcelDate(a.startDate) || new Date(0);
                    const dateB = parseExcelDate(b.startDate) || new Date(0);
                    const dateDiff = dateA - dateB;
                    if (dateDiff !== 0) return dateDiff;

                    // 3. æ°åæ˜‡é †
                    return (a.name || '').localeCompare(b.name || '');
                });
            });

            debugLog('Column distribution', {
                column3: columns[3].length,
                column2: columns[2].length,
                column1: columns[1].length
            });

            displayCards(columns);
        }

        function parseExcelDate(dateValue) {
            if (!dateValue) return null;
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨
            debugLog(`Parsing date: ${dateValue} (type: ${typeof dateValue})`);
            
            if (typeof dateValue === 'number') {
                // Excelã‚·ãƒªã‚¢ãƒ«å€¤ã‚’æ—¥ä»˜ã«å¤‰æ›
                if (dateValue > 0 && dateValue < 100000) { // å¦¥å½“ãªç¯„å›²ãƒã‚§ãƒƒã‚¯
                    const excelEpoch = new Date(1899, 11, 30);
                    const result = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                    debugLog(`Parsed Excel serial ${dateValue} to ${result}`);
                    return result;
                }
            } else if (typeof dateValue === 'string') {
                // æ–‡å­—åˆ—ã®æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹
                if (dateValue.trim() === '') return null;
                
                // æ—¥æœ¬ã®æ—¥ä»˜å½¢å¼ã‚’è©¦è¡Œ
                const patterns = [
                    /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/,  // YYYY/MM/DD, YYYY-MM-DD
                    /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/   // MM/DD/YYYY, DD/MM/YYYY
                ];
                
                for (let pattern of patterns) {
                    const match = dateValue.match(pattern);
                    if (match) {
                        let year, month, day;
                        if (pattern === patterns[0]) {
                            year = parseInt(match[1]);
                            month = parseInt(match[2]) - 1; // 0ãƒ™ãƒ¼ã‚¹
                            day = parseInt(match[3]);
                        } else {
                            // MM/DD/YYYY ã¨ã—ã¦è§£é‡ˆ
                            year = parseInt(match[3]);
                            month = parseInt(match[1]) - 1;
                            day = parseInt(match[2]);
                        }
                        
                        const result = new Date(year, month, day);
                        if (!isNaN(result.getTime())) {
                            debugLog(`Parsed string "${dateValue}" to ${result}`);
                            return result;
                        }
                    }
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¨™æº–Date constructor
                const result = new Date(dateValue);
                if (!isNaN(result.getTime())) {
                    debugLog(`Parsed string "${dateValue}" with Date constructor to ${result}`);
                    return result;
                }
            } else if (dateValue instanceof Date) {
                if (!isNaN(dateValue.getTime())) {
                    debugLog(`Date object: ${dateValue}`);
                    return dateValue;
                }
            }
            
            debugLog(`Failed to parse date: ${dateValue}`);
            return null;
        }

        function formatDate(date) {
            if (!date) return '';
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        function displayCards(columns) {
            debugLog('Displaying cards');
            
            Object.keys(columns).forEach(key => {
                const columnElement = document.getElementById(`column-${key}`);
                const countElement = document.getElementById(`count-${key}`);
                
                if (!columnElement || !countElement) {
                    debugLog(`ERROR: Column elements not found for key ${key}`);
                    return;
                }
                
                const cards = columns[key];

                // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
                countElement.textContent = `(${cards.length})`;

                // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
                columnElement.innerHTML = cards.map(card => createCardHTML(card)).join('');
            });
            
            debugLog('Cards displayed successfully');
        }

        function createCardHTML(data) {
            const remaining = data.remaining || 0;
            const handMatch = data.handMatch || 0;
            const application = data.application || 0;

            // æ®‹æ•°ã®è‰²åˆ†ã‘ï¼š0=èµ¤ã€1ã€œ3=é»„è‰²ã€4ä»¥ä¸Š=é’
            let remainingBadge;
            if (remaining === 0) {
                remainingBadge = 'badge-red';
            } else if (remaining >= 1 && remaining <= 3) {
                remainingBadge = 'badge-yellow';
            } else {
                remainingBadge = 'badge-blue';
            }

            // æ‰‹ãƒãƒƒãƒã®è‰²åˆ†ã‘ï¼š10æœªæº€=èµ¤ã€10ã€œ19=é»„è‰²ã€20ä»¥ä¸Š=é’
            let handMatchBadge;
            if (handMatch < 10) {
                handMatchBadge = 'badge-red';
            } else if (handMatch >= 10 && handMatch <= 19) {
                handMatchBadge = 'badge-yellow';
            } else {
                handMatchBadge = 'badge-blue';
            }

            // å¿œå‹Ÿã®è‰²åˆ†ã‘ï¼šæ®‹æ•°+å¿œå‹Ÿæ•°<5=èµ¤ã€æ®‹æ•°+å¿œå‹Ÿæ•°>=5=é’
            const totalCount = remaining + application;
            const applicationBadge = totalCount < 5 ? 'badge-red' : 'badge-blue';

            return `
                <div class="notion-card" style="padding: 16px; margin-bottom: 12px; transition: all 0.2s ease;">
                    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šæ±‚è·è€…No + æ°åï¼ˆåŒã˜è¡Œãƒ»åŒã˜ã‚µã‚¤ã‚ºï¼‰ -->
                    <div class="mb-3 flex items-center gap-2">
                        <span style="font-size: 15px; font-weight: 600; color: #37352F;">${escapeHtml(data.jobSeekerId || '')}</span>
                        <span style="font-size: 15px; font-weight: 600; color: #37352F;">${escapeHtml(data.name || '')}</span>
                    </div>
                    
                    <!-- ãƒãƒƒã‚¸ -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="badge ${remainingBadge}">æ®‹ ${remaining}</span>
                        <span class="badge ${handMatchBadge}">æ‰‹ãƒãƒƒãƒ ${handMatch}</span>
                        <span class="badge ${applicationBadge}">å¿œå‹Ÿ ${application}</span>
                    </div>
                    
                    <!-- ãƒ¡ãƒ¢æ¬„ -->
                    <div style="padding: 0 4px;">
                        <textarea 
                            class="memo-input rounded" 
                            rows="2" 
                            placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
                            data-row-index="${data.originalRowIndex}"
                            onchange="updateMemo(this, ${data.originalRowIndex})"
                            style="width: 100%; font-size: 13px; padding: 8px; resize: none; line-height: 1.5; border: 1px solid rgba(55, 53, 47, 0.16); background-color: #FFFFFF; box-sizing: border-box;"
                        >${escapeHtml(data.memo || '')}</textarea>
                    </div>
                </div>
            `;
        }

        // ãƒ¡ãƒ¢æ›´æ–°é–¢æ•°
        function updateMemo(textarea, rowIndex) {
            const newMemo = textarea.value;
            debugLog(`Updating memo for row ${rowIndex}: ${newMemo}`);
            
            // worksheetDataã‚’æ›´æ–°
            const dataItem = worksheetData.find(item => item.originalRowIndex === rowIndex);
            if (dataItem) {
                dataItem.memo = newMemo;
                debugLog('Memo updated in worksheetData');
            }
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã®ã‚»ãƒ«ã‚‚æ›´æ–°
            if (workbook && workbook.Sheets) {
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Iåˆ—ï¼ˆãƒ¡ãƒ¢åˆ—ï¼‰ã®ã‚»ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                const cellAddress = XLSX.utils.encode_cell({ r: rowIndex, c: 8 });
                
                if (newMemo.trim() === '') {
                    // ãƒ¡ãƒ¢ãŒç©ºã®å ´åˆã¯ã‚»ãƒ«ã‚’å‰Šé™¤
                    delete worksheet[cellAddress];
                } else {
                    // ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯ã‚»ãƒ«ã‚’æ›´æ–°
                    worksheet[cellAddress] = { v: newMemo, t: 's' };
                }
                
                debugLog(`Updated Excel cell ${cellAddress} with memo: ${newMemo}`);
            }
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ä¿å­˜æ©Ÿèƒ½ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šå¯¾å¿œï¼‰
        async function handleSave() {
            debugLog('Save button clicked');
            
            if (!workbook) {
                alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                const fileType = isXlsmFormat ? 'xlsm' : 'xlsx';
                const defaultFilename = originalFilename || `tasks.${fileType}`;

                // File System Access APIå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
                if ('showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: defaultFilename,
                            types: [{
                                description: 'Excel files',
                                accept: {
                                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
                                    'application/vnd.ms-excel.sheet.macroEnabled.12': ['.xlsm']
                                }
                            }]
                        });

                        // ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
                        const writable = await fileHandle.createWritable();
                        const buffer = XLSX.write(workbook, {
                            bookType: fileType,
                            bookVBA: isXlsmFormat,
                            type: 'buffer'
                        });
                        await writable.write(buffer);
                        await writable.close();

                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
                        debugLog('File saved successfully with folder picker');
                        
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            debugLog('ERROR with folder picker: ' + error.message);
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ¨™æº–ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            fallbackSave(fileType, defaultFilename);
                        }
                    }
                } else {
                    // File System Access APIéå¯¾å¿œã®å ´åˆ
                    fallbackSave(fileType, defaultFilename);
                }
                
            } catch (error) {
                debugLog('ERROR saving file: ' + error.message);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜æ©Ÿèƒ½
        function fallbackSave(fileType, filename) {
            try {
                XLSX.writeFile(workbook, filename, {
                    bookType: fileType,
                    bookVBA: isXlsmFormat
                });
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
                debugLog('File saved with fallback method');
            } catch (error) {
                debugLog('ERROR with fallback save: ' + error.message);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã§åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM Content Loaded');
            
            // SheetJSã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
            if (typeof XLSX === 'undefined') {
                debugLog('XLSX not yet loaded, waiting...');
                setTimeout(() => {
                    initializeApp();
                }, 1000);
            } else {
                initializeApp();
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œ
        window.addEventListener('load', function() {
            debugLog('Window loaded');
            if (typeof initializeApp === 'function' && typeof XLSX !== 'undefined') {
                // DOMè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹å†ç¢ºèª
                if (document.getElementById('dropZone') && document.getElementById('excelFile')) {
                    debugLog('Elements found, reinitializing if needed');
                }
            }
        });
    </script>
</body>
</html>
